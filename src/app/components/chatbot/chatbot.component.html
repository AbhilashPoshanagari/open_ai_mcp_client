<div #chatMessages class="chat-messages" (scroll)="onChatScroll()">
  @for (message of messages; track message) {
    <div class="message-container" [ngClass]="{
            'user-message': message.role === 'user', 
            'bot-message': message.role === 'bot',
            'layout-message': hasMapLayout(message),
            'map-layout-active': hasMapLayout(message)}">
      <div class="message-content">
        <div class="message-text markdown-body">
          @if (message.content && typeof message.content === 'string') {
            <markdown [data]="message.content"></markdown>
          }
        </div>

        <!-- Updated chatbot HTML for AG Grid tables -->
          @if (message.layouts | filterTables; as tables) {
            <div class="tables-container">
              @for (table of tables; track $index) {
                <div class="table-wrapper">
                  <div class="workspace-action">
                    <button mat-icon-button (click)="selectLayout(table); $event.stopPropagation()" 
                            class="open-workspace-btn" title="Open in Workspace">
                      <mat-icon>open_in_new</mat-icon>
                    </button>
                  </div>
                  @if (table | hasValidTableStructure) {
                    <app-chat-data-table [tableData]="table.data" />
                  } @else {
                    <div class="table-error">
                      <i class="error-icon">⚠️</i>
                      Invalid table structure
                    </div>
                  }
                </div>
              }
            </div>
          }

        <!-- Buttons with Pipes -->
        @if (message.layouts | filterButtons; as buttons) {
          <div class="button-container">
            @for (button of buttons; track button) {
              <div class="button-wrapper">
                @if (button | hasValidButtonStructure) {
                  <a
                    [href]="button | getButtonLink"
                    [target]="(button | isExternalLink) ? '_blank' : '_self'"
                    class="dynamic-button"
                    [attr.rel]="(button | isExternalLink) ? 'noopener noreferrer' : null">
                    {{ button | getButtonTitle }}
                  </a>
                } @else {
                  <div class="button-error">Invalid button structure</div>
                }
              </div>
            }
          </div>
        }

        <!-- Maps with optimized pipes -->
        @if (message.layouts | filterMaps; as maps) {
          <div class="map-container">
            @for (mapLayout of maps; track mapLayout; let mapIndex = $index) {
              @if (mapLayout | isValidMapLayout) {
                <div class="map-wrapper" >
                  <div class="workspace-action">
                    <button mat-icon-button (click)="selectLayout(mapLayout); $event.stopPropagation()" 
                            class="open-workspace-btn" title="Open in Workspace">
                      <mat-icon>open_in_new</mat-icon>
                    </button>
                  </div>
                  <!-- Use hasMapTitle pipe for condition -->
                  @if (mapLayout | hasMapTitle) {
                    <div class="map-header">{{ mapLayout | getMapTitle }}</div>
                  }
                  <!-- Use individual pipes for each property -->
                  <app-map
                    [featureDetails]="mapLayout | getMapFeatures"
                    [wmsLayers]="mapLayout | getMapWmsLayers"
                    [center]="mapLayout | getMapCenter"
                    [zoom]="mapLayout | getMapZoom"
                    [showPopup]="true"
                    [height]="mapLayout | getMapHeight"
                    (featureClick)="onFeatureClick($event)">
                  </app-map>
                </div>
              } @else {
                <div class="map-error">Invalid map layout</div>
              }
            }
          </div>
        }

        <!-- Form layouts -->
        @if (message.layouts && message.layouts.length > 0) {
          <div class="form-layouts">
            @for (layout of message.layouts | filterForms; track $index) {
              <div class="form-container" >
                @if (layout | isValidFormLayout) {
                  <div class="workspace-action">
                    <button mat-icon-button (click)="selectLayout(layout); $event.stopPropagation()" 
                            class="open-workspace-btn" title="Open in Workspace">
                      <mat-icon>open_in_new</mat-icon>
                    </button>
                  </div>
                  <app-chat-form
                    [formLayout]="layout"
                    (formSubmitted)="onChatFormSubmitted($event, message)"
                    (formCancelled)="onChatFormCancelled()"
                    (kanbanAction)="onKanbanAction($event)"
                    (kanbanBoardUpdated)="onKanbanBoardUpdated($event)">
                  </app-chat-form>
                } @else {
                  <div class="invalid-form">
                    Invalid form layout - check console for details
                  </div>
                }
              </div>
            }
          </div>
        }


        <!-- Kanban layouts (NEW) -->
        @if (message.layouts && message.layouts.length > 0) {
          <div class="kanban-layouts">
            @for (layout of message.layouts | filterKanban; track $index) {
              <div class="kanban-container">
                @if (layout | isKanbanLayout) {
                  <div class="workspace-action">
                    <button mat-icon-button (click)="selectLayout(layout); $event.stopPropagation()" 
                            class="open-workspace-btn" title="Open in Workspace">
                      <mat-icon>open_in_new</mat-icon>
                    </button>
                  </div>
                  <app-chat-kanban
                    [kanbanLayout]="layout"
                    (actionTriggered)="onKanbanAction($event)"
                    (boardUpdated)="onKanbanBoardUpdated($event)">
                  </app-chat-kanban>
                } @else {
                  <div class="invalid-kanban">
                    Invalid kanban layout
                  </div>
                }
              </div>
            }
          </div>
        }

        <div class="message-time">{{message.timestamp | date:'shortTime'}}</div>
      </div>
    </div>
  }
</div>
