<!-- elicitation.component.html -->
<div *ngIf="formAvailable">
<div *ngIf="schema$ | async as schema; else noRequest" class="elicitation-container">
  <div *ngIf="form$ | async as form">
    <h2>{{title}}</h2>
    <p *ngIf="currentRequest?.params?.message">{{ currentRequest.params.message }}</p>
    
    <div *ngIf="validationErrors.length" class="alert alert-danger">
      <h4>Validation Errors</h4>
      <ul>
        <li *ngFor="let error of validationErrors">{{ error }}</li>
      </ul>
    </div>

    <div *ngIf="!showConfirmation">
      <form [formGroup]="form" (ngSubmit)="onSubmit(form)" class="form-table">
        <div class="form-table-body">
          <div *ngFor="let fieldName of getFieldNames(schema.schema)" class="form-row">
            <ng-container [ngSwitch]="getFieldType(schema.schema, fieldName)">
              
              <!-- Text Input -->
              <div *ngSwitchCase="'string'" class="form-field">
                <div class="label-container">
                  <label [for]="fieldName">
                    {{ getFieldTitle(schema.schema, fieldName) }}
                    <span *ngIf="isFieldRequired(schema.schema, fieldName)" class="required">*</span>
                  </label>
                </div>
                <div *ngIf="!getFieldOptions(schema.schema, fieldName).length" class="input-container">
                  <input
                    [id]="fieldName"
                    type="text"
                    [formControlName]="fieldName"
                    class="form-control"
                    [value]="getFieldDefault(schema.schema, fieldName)"
                    [placeholder]="getFieldExamples(schema.schema, fieldName)"
                  />
                  <small *ngIf="getFieldDescription(schema.schema, fieldName)" class="form-text text-muted">
                    {{ getFieldDescription(schema.schema, fieldName) }}
                  </small>
                </div>
                <div *ngIf="getFieldOptions(schema.schema, fieldName).length" class="input-container">
                  <select
                    [id]="fieldName"
                    [formControlName]="fieldName"
                    class="form-control"
                  >
                    <option *ngIf="!isFieldRequired(schema.schema, fieldName)" value="">(Skip)</option>
                    <option *ngFor="let option of getFieldOptions(schema.schema, fieldName)" [value]="option">
                      {{ option }}
                    </option>
                  </select>
                  <small *ngIf="getFieldDescription(schema.schema, fieldName)" class="form-text text-muted">
                    {{ getFieldDescription(schema.schema, fieldName) }}
                  </small>
                </div>
              </div>

              <!-- Password Input -->
              <div *ngSwitchCase="'password'" class="form-field">
                <div class="label-container">
                  <label [for]="fieldName">
                    {{ getFieldTitle(schema.schema, fieldName) }}
                    <span *ngIf="isFieldRequired(schema.schema, fieldName)" class="required">*</span>
                  </label>
                </div>
                <div class="input-container">
                  <input
                    [id]="fieldName"
                    type="password"
                    [formControlName]="fieldName"
                    class="form-control"
                    [value]="getFieldDefault(schema.schema, fieldName)"
                  />
                </div>
              </div>

              <!-- Number Input -->
              <div *ngSwitchCase="'number'" class="form-field">
                <div class="label-container">
                  <label [for]="fieldName">
                    {{ getFieldTitle(schema.schema, fieldName) }}
                    <span *ngIf="isFieldRequired(schema.schema, fieldName)" class="required">*</span>
                  </label>
                </div>
                <div class="input-container">
                  <input
                    [id]="fieldName"
                    type="number"
                    [formControlName]="fieldName"
                    class="form-control"
                    [placeholder]="getFieldExamples(schema.schema, fieldName)"
                    [value]="getFieldDefault(schema.schema, fieldName)"
                    [min]="getFieldMin(schema.schema, fieldName)"
                    [max]="getFieldMax(schema.schema, fieldName)"
                  />
                  <small *ngIf="getFieldDescription(schema.schema, fieldName)" class="form-text text-muted">
                    {{ getFieldDescription(schema.schema, fieldName) }}
                  </small>
                </div>
              </div>

              <!-- Integer Input -->
              <div *ngSwitchCase="'integer'" class="form-field">
                <div class="label-container">
                  <label [for]="fieldName">
                    {{ getFieldTitle(schema.schema, fieldName) }}
                    <span *ngIf="isFieldRequired(schema.schema, fieldName)" class="required">*</span>
                  </label>
                </div>
                <div class="input-container">
                  <input
                    [id]="fieldName"
                    type="number"
                    [formControlName]="fieldName"
                    class="form-control"
                    [placeholder]="getFieldExamples(schema.schema, fieldName)"
                    [value]="getFieldDefault(schema.schema, fieldName)"
                    [min]="getFieldMin(schema.schema, fieldName)"
                    [max]="getFieldMax(schema.schema, fieldName)"
                  />
                  <small *ngIf="getFieldDescription(schema.schema, fieldName)" class="form-text text-muted">
                    {{ getFieldDescription(schema.schema, fieldName) }}
                  </small>
                </div>
              </div>

              <!-- Select Dropdown -->
              <div *ngSwitchCase="'enum'" class="form-field">
                <div class="label-container">
                  <label [for]="fieldName">
                    {{ getFieldTitle(schema.schema, fieldName) }}
                    <span *ngIf="isFieldRequired(schema.schema, fieldName)" class="required">*</span>
                  </label>
                </div>
                <div class="input-container">
                  <select
                    [id]="fieldName"
                    [formControlName]="fieldName"
                    class="form-control"
                  >
                    <option *ngIf="!isFieldRequired(schema.schema, fieldName)" value="">(Skip)</option>
                    <option *ngFor="let option of getFieldOptions(schema.schema, fieldName)" [value]="option">
                      {{ option }}
                    </option>
                  </select>
                  <small *ngIf="getFieldDescription(schema.schema, fieldName)" class="form-text text-muted">
                    {{ getFieldDescription(schema.schema, fieldName) }}
                  </small>
                </div>
              </div>

              <!-- Boolean Checkbox -->
              <div *ngSwitchCase="'boolean'" class="form-field">
                <div class="label-container">
                  <label [for]="fieldName">
                    {{ getFieldTitle(schema.schema, fieldName) }}
                  </label>
                </div>
                <div class="input-container">
                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      [id]="fieldName"
                      [formControlName]="fieldName"
                      class="form-checkbox"
                    />
                    <label [for]="fieldName" class="checkbox-label">
                      {{ getFieldTitle(schema.schema, fieldName) }}
                    </label>
                  </div>
                  <small *ngIf="getFieldDescription(schema.schema, fieldName)" class="form-text text-muted">
                    {{ getFieldDescription(schema.schema, fieldName) }}
                  </small>
                </div>
              </div>

            </ng-container>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" [disabled]="waitingForResponse" class="btn btn-primary">Submit</button>
          <button type="button" (click)="cancel()" class="btn btn-secondary">Cancel</button>
        </div>
        <div *ngIf="waitingForResponse">
          <!-- <mat-spinner></mat-spinner> -->
          @if (waitingForResponse) {
              <img src="gif/Spinner.gif"/>
            }
        </div>
      </form>
    </div>

    <div *ngIf="showConfirmation" class="confirmation-dialog">
      <h3>Confirm Submission</h3>
      <pre>{{ maskSensitiveData(submittedData) | json }}</pre>
      
      <div class="confirmation-actions">
        <button (click)="confirmSubmission(true)" class="btn btn-success">Confirm</button>
        <button (click)="onEdit()" class="btn btn-warning">Edit</button>
        <button (click)="confirmSubmission(false)" class="btn btn-warning">Cancel</button>
      </div>
    </div>
  </div>
</div>
</div>
<ng-template #noRequest>
  <div class="no-request">
    <p>No active elicitation request</p>
  </div>
</ng-template>