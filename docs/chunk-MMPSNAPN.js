import{j as I,q as l}from"./chunk-FT3LMQJV.js";import{a as n,b,c as C,d as _,i as u,pg as d}from"./chunk-PR3HXOEE.js";var M=class N extends d{static lc_name(){return"StuffDocumentsChain"}llmChain;inputKey="input_documents";documentVariableName="context";get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys].filter(t=>t!==this.documentVariableName)}get outputKeys(){return this.llmChain.outputKeys}constructor(t){super(t),this.llmChain=t.llmChain,this.documentVariableName=t.documentVariableName??this.documentVariableName,this.inputKey=t.inputKey??this.inputKey}_prepInputs(t){var r;if(!(this.inputKey in t))throw new Error(`Document key ${this.inputKey} not found.`);let i=t,{[r=this.inputKey]:e}=i,s=_(i,[C(r)]),a=e.map(({pageContent:h})=>h).join(`

`);return b(n({},s),{[this.documentVariableName]:a})}_call(t,e){return u(this,null,function*(){return yield this.llmChain.call(this._prepInputs(t),e?.getChild("combine_documents"))})}_chainType(){return"stuff_documents_chain"}static deserialize(t){return u(this,null,function*(){if(!t.llm_chain)throw new Error("Missing llm_chain");return new N({llmChain:yield l.deserialize(t.llm_chain)})})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}},T=class x extends d{static lc_name(){return"MapReduceDocumentsChain"}llmChain;inputKey="input_documents";documentVariableName="context";returnIntermediateSteps=!1;get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}maxTokens=3e3;maxIterations=10;ensureMapStep=!1;combineDocumentChain;constructor(t){super(t),this.llmChain=t.llmChain,this.combineDocumentChain=t.combineDocumentChain,this.documentVariableName=t.documentVariableName??this.documentVariableName,this.ensureMapStep=t.ensureMapStep??this.ensureMapStep,this.inputKey=t.inputKey??this.inputKey,this.maxTokens=t.maxTokens??this.maxTokens,this.maxIterations=t.maxIterations??this.maxIterations,this.returnIntermediateSteps=t.returnIntermediateSteps??!1}_call(t,e){return u(this,null,function*(){var f;if(!(this.inputKey in t))throw new Error(`Document key ${this.inputKey} not found.`);let p=t,{[f=this.inputKey]:s}=p,o=_(p,[C(f)]),a=s,r=[];for(let m=0;m<this.maxIterations;m+=1){let y=a.map(c=>n({[this.documentVariableName]:c.pageContent},o));if(m!==0||!this.ensureMapStep){let c=yield this.combineDocumentChain.llmChain.prompt.format(this.combineDocumentChain._prepInputs(n({[this.combineDocumentChain.inputKey]:a},o)));if((yield this.combineDocumentChain.llmChain._getNumTokens(c))<this.maxTokens)break}let w=yield this.llmChain.apply(y,e?Array.from({length:y.length},(c,g)=>e.getChild(`map_${g+1}`)):void 0),{outputKey:D}=this.llmChain;this.returnIntermediateSteps&&(r=r.concat(w.map(c=>c[D]))),a=w.map(c=>({pageContent:c[D],metadata:{}}))}let i=n({[this.combineDocumentChain.inputKey]:a},o),h=yield this.combineDocumentChain.call(i,e?.getChild("combine_documents"));return this.returnIntermediateSteps?b(n({},h),{intermediateSteps:r}):h})}_chainType(){return"map_reduce_documents_chain"}static deserialize(t){return u(this,null,function*(){if(!t.llm_chain)throw new Error("Missing llm_chain");if(!t.combine_document_chain)throw new Error("Missing combine_document_chain");return new x({llmChain:yield l.deserialize(t.llm_chain),combineDocumentChain:yield M.deserialize(t.combine_document_chain)})})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}},k=class S extends d{static lc_name(){return"RefineDocumentsChain"}llmChain;inputKey="input_documents";outputKey="output_text";documentVariableName="context";initialResponseName="existing_answer";refineLLMChain;get defaultDocumentPrompt(){return new I({inputVariables:["page_content"],template:"{page_content}"})}documentPrompt=this.defaultDocumentPrompt;get inputKeys(){return[...new Set([this.inputKey,...this.llmChain.inputKeys,...this.refineLLMChain.inputKeys])].filter(t=>t!==this.documentVariableName&&t!==this.initialResponseName)}get outputKeys(){return[this.outputKey]}constructor(t){super(t),this.llmChain=t.llmChain,this.refineLLMChain=t.refineLLMChain,this.documentVariableName=t.documentVariableName??this.documentVariableName,this.inputKey=t.inputKey??this.inputKey,this.outputKey=t.outputKey??this.outputKey,this.documentPrompt=t.documentPrompt??this.documentPrompt,this.initialResponseName=t.initialResponseName??this.initialResponseName}_constructInitialInputs(t,e){return u(this,null,function*(){let s=n({page_content:t.pageContent},t.metadata),o={};this.documentPrompt.inputVariables.forEach(i=>{o[i]=s[i]});let a={[this.documentVariableName]:yield this.documentPrompt.format(n({},o))};return n(n({},a),e)})}_constructRefineInputs(t,e){return u(this,null,function*(){let s=n({page_content:t.pageContent},t.metadata),o={};this.documentPrompt.inputVariables.forEach(i=>{o[i]=s[i]});let a={[this.documentVariableName]:yield this.documentPrompt.format(n({},o))};return n({[this.initialResponseName]:e},a)})}_call(t,e){return u(this,null,function*(){var f;if(!(this.inputKey in t))throw new Error(`Document key ${this.inputKey} not found.`);let p=t,{[f=this.inputKey]:s}=p,o=_(p,[C(f)]),a=s,r=yield this._constructInitialInputs(a[0],o),i=yield this.llmChain.predict(n({},r),e?.getChild("answer")),h=[i];for(let m=1;m<a.length;m+=1){let y=yield this._constructRefineInputs(a[m],i),K=n(n({},y),o);i=yield this.refineLLMChain.predict(n({},K),e?.getChild("refine")),h.push(i)}return{[this.outputKey]:i}})}_chainType(){return"refine_documents_chain"}static deserialize(t){return u(this,null,function*(){let e=t.llm_chain;if(!e)throw new Error("Missing llm_chain");let s=t.refine_llm_chain;if(!s)throw new Error("Missing refine_llm_chain");return new S({llmChain:yield l.deserialize(e),refineLLMChain:yield l.deserialize(s)})})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}};export{M as a,T as b,k as c};
