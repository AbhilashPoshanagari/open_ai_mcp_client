import{Ae as Pe,Nd as rt,Od as dt,Pd as Te,Pf as Se,Qd as at,Sf as zt,Wf as R,Xf as Ce,a as d,b as _,d as ge,df as Ee,ee as St,ef as st,eg as Ie,fe as Ct,fg as Oe,ge as be,gg as Ne,i as h,if as ve,j,jf as $t,k as et,l as de,m as ht,me as Gt,o as gt,og as Ae,pe as _e,pg as Me,re as ye,te as we,uf as xe,ye as It}from"./chunk-PR3HXOEE.js";var Xt=class extends R{parseResultWithPrompt(e,t,a){return this.parseResult(e,a)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}invoke(e,t){return h(this,null,function*(){return typeof e=="string"?this._callWithConfig((a,i)=>h(this,null,function*(){return this.parseResult([{text:a}],i?.callbacks)}),e,_(d({},t),{runType:"parser"})):this._callWithConfig((a,i)=>h(this,null,function*(){return this.parseResult([{message:a,text:this._baseMessageToString(a)}],i?.callbacks)}),e,_(d({},t),{runType:"parser"}))})}},W=class extends Xt{parseResult(e,t){return this.parse(e[0].text,t)}parseWithPrompt(e,t,a){return h(this,null,function*(){return this.parse(e,a)})}_type(){throw new Error("_type not implemented")}},G=class extends Error{llmOutput;observation;sendToLLM;constructor(e,t,a,i=!1){if(super(e),this.llmOutput=t,this.observation=a,this.sendToLLM=i,i&&(a===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");at(this,"OUTPUT_PARSING_FAILURE")}};var Y=class extends W{_transform(e){return et(this,null,function*(){try{for(var t=ht(e),a,i,n;a=!(i=yield new j(t.next())).done;a=!1){let l=i.value;typeof l=="string"?yield this.parseResult([{text:l}]):yield this.parseResult([{message:l,text:this._baseMessageToString(l)}])}}catch{n=[i]}finally{try{a&&(i=t.return)&&(yield new j(i.call(t)))}finally{if(n)throw n[0]}}})}transform(e,t){return et(this,null,function*(){yield*de(this._transformStreamWithConfig(e,this._transform.bind(this),_(d({},t),{runType:"parser"})))})}},nt=class extends Y{diff=!1;constructor(e){super(e),this.diff=e?.diff??this.diff}_transform(e){return et(this,null,function*(){let t,a;try{for(var i=ht(e),n,l,c;n=!(l=yield new j(i.next())).done;n=!1){let p=l.value;if(typeof p!="string"&&typeof p.content!="string")throw new Error("Cannot handle non-string output.");let f;if(be(p)){if(typeof p.content!="string")throw new Error("Cannot handle non-string message output.");f=new $t({message:p,text:p.content})}else if(Ct(p)){if(typeof p.content!="string")throw new Error("Cannot handle non-string message output.");f=new $t({message:Pe(p),text:p.content})}else f=new ve({text:p});a===void 0?a=f:a=a.concat(f);let g=yield new j(this.parsePartialResult([a]));g!=null&&!Se(g,t)&&(this.diff?yield this._diff(t,g):yield g,t=g)}}catch{c=[l]}finally{try{n&&(l=i.return)&&(yield new j(l.call(i)))}finally{if(c)throw c[0]}}})}getFormatInstructions(){return""}};var or={};rt(or,{applyPatch:()=>Ee,compare:()=>st});var Fe=class extends nt{static lc_name(){return"JsonOutputParser"}lc_namespace=["langchain_core","output_parsers"];lc_serializable=!0;_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?st(e,t):[{op:"replace",path:"",value:t}]}parsePartialResult(e){return h(this,null,function*(){return dt(e[0].text)})}parse(e){return h(this,null,function*(){return dt(e,JSON.parse)})}getFormatInstructions(){return""}};var Ve=class extends Y{static lc_name(){return"BytesOutputParser"}lc_namespace=["langchain_core","output_parsers","bytes"];lc_serializable=!0;textEncoder=new TextEncoder;parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}};var it=class extends Y{re;_transform(e){return et(this,null,function*(){let t="";try{for(var a=ht(e),i,n,l;i=!(n=yield new j(a.next())).done;i=!1){let c=n.value;if(typeof c=="string"?t+=c:t+=c.content,this.re){let p=[...t.matchAll(this.re)];if(p.length>1){let f=0;for(let g of p.slice(0,-1))yield[g[1]],f+=(g.index??0)+g[0].length;t=t.slice(f)}}else{let p=yield new j(this.parse(t));if(p.length>1){for(let f of p.slice(0,-1))yield[f];t=p[p.length-1]}}}}catch{l=[n]}finally{try{i&&(n=a.return)&&(yield new j(n.call(a)))}finally{if(l)throw l[0]}}for(let c of yield new j(this.parse(t)))yield[c]})}},De=class extends it{static lc_name(){return"CommaSeparatedListOutputParser"}lc_namespace=["langchain_core","output_parsers","list"];lc_serializable=!0;parse(e){return h(this,null,function*(){try{return e.trim().split(",").map(t=>t.trim())}catch{throw new G(`Could not parse output: ${e}`,e)}})}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},Re=class extends it{lc_namespace=["langchain_core","output_parsers","list"];length;separator;constructor({length:e,separator:t}){super(...arguments),this.length=e,this.separator=t||","}parse(e){return h(this,null,function*(){try{let t=e.trim().split(this.separator).map(a=>a.trim());if(this.length!==void 0&&t.length!==this.length)throw new G(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){throw Object.getPrototypeOf(t)===G.prototype?t:new G(`Could not parse output: ${e}`)}})}getFormatInstructions(){return`Your response should be a list of ${this.length===void 0?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},Be=class extends it{static lc_name(){return"NumberedListOutputParser"}lc_namespace=["langchain_core","output_parsers","list"];lc_serializable=!0;getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}re=/\d+\.\s([^\n]+)/g;parse(e){return h(this,null,function*(){return[...e.matchAll(this.re)??[]].map(t=>t[1])})}},Le=class extends it{static lc_name(){return"NumberedListOutputParser"}lc_namespace=["langchain_core","output_parsers","list"];lc_serializable=!0;getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}re=/^\s*[-*]\s([^\n]+)$/gm;parse(e){return h(this,null,function*(){return[...e.matchAll(this.re)??[]].map(t=>t[1])})}};var Ue=class extends Y{static lc_name(){return"StrOutputParser"}lc_namespace=["langchain_core","output_parsers","string"];lc_serializable=!0;parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((t,a)=>t+this._messageContentToString(a),"")}};var Wt=class extends W{static lc_name(){return"StructuredOutputParser"}lc_namespace=["langchain","output_parsers","structured"];toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),this.schema=e}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=gt.object(Object.fromEntries(Object.entries(e).map(([a,i])=>[a,gt.string().describe(i)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(zt(this.schema))}
\`\`\`
`}parse(e){return h(this,null,function*(){try{let t=e.trim(),i=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(n,l)=>`"${l.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return yield xe(this.schema,JSON.parse(i))}catch(t){throw new G(`Failed to parse. Text: "${e}". Error: ${t}`,e)}})}},Yt=class extends Wt{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(e){let t=e?.interpolationDepth??1;if(t<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(zt(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}
\`\`\``}_schemaToInstruction(e,t=2){let a=e;if("type"in a){let i=!1,n;if(Array.isArray(a.type)){let p=a.type.findIndex(f=>f==="null");p!==-1&&(i=!0,a.type.splice(p,1)),n=a.type.join(" | ")}else n=a.type;if(a.type==="object"&&a.properties){let p=a.description?` // ${a.description}`:"";return`{
${Object.entries(a.properties).map(([g,x])=>{let M=a.required?.includes(g)?"":" (optional)";return`${" ".repeat(t)}"${g}": ${this._schemaToInstruction(x,t+2)}${M}`}).join(`
`)}
${" ".repeat(t-2)}}${p}`}if(a.type==="array"&&a.items){let p=a.description?` // ${a.description}`:"";return`array[
${" ".repeat(t)}${this._schemaToInstruction(a.items,t+2)}
${" ".repeat(t-2)}] ${p}`}let l=i?" (nullable)":"",c=a.description?` // ${a.description}`:"";return`${n}${c}${l}`}if("anyOf"in a)return a.anyOf.map(i=>this._schemaToInstruction(i,t)).join(`
${" ".repeat(t-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=gt.object(Object.fromEntries(Object.entries(e).map(([a,i])=>[a,gt.string().describe(i)])));return new this(t)}},je=class extends W{structuredInputParser;constructor({inputSchema:e}){super(...arguments),this.structuredInputParser=new Yt(e)}parse(e){return h(this,null,function*(){let t;try{t=yield this.structuredInputParser.parse(e)}catch(a){throw new G(`Failed to parse. Text: "${e}". Error: ${a}`,e)}return this.outputProcessor(t)})}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}};var lr=function(){let e={};e.parser=function(s,r){return new a(s,r)},e.SAXParser=a,e.SAXStream=g,e.createStream=f,e.MAX_BUFFER_LENGTH=65536;let t=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];e.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function a(s,r){if(!(this instanceof a))return new a(s,r);var m=this;n(m),m.q=m.c="",m.bufferCheckPosition=e.MAX_BUFFER_LENGTH,m.opt=r||{},m.opt.lowercase=m.opt.lowercase||m.opt.lowercasetags,m.looseCase=m.opt.lowercase?"toLowerCase":"toUpperCase",m.tags=[],m.closed=m.closedRoot=m.sawRoot=!1,m.tag=m.error=null,m.strict=!!s,m.noscript=!!(s||m.opt.noscript),m.state=u.BEGIN,m.strictEntities=m.opt.strictEntities,m.ENTITIES=m.strictEntities?Object.create(e.XML_ENTITIES):Object.create(e.ENTITIES),m.attribList=[],m.opt.xmlns&&(m.ns=Object.create(vt)),m.trackPosition=m.opt.position!==!1,m.trackPosition&&(m.position=m.line=m.column=0),mt(m,"onready")}Object.create||(Object.create=function(s){function r(){}r.prototype=s;var m=new r;return m}),Object.keys||(Object.keys=function(s){var r=[];for(var m in s)s.hasOwnProperty(m)&&r.push(m);return r});function i(s){for(var r=Math.max(e.MAX_BUFFER_LENGTH,10),m=0,o=0,T=t.length;o<T;o++){var E=s[t[o]].length;if(E>r)switch(t[o]){case"textNode":ft(s);break;case"cdata":P(s,"oncdata",s.cdata),s.cdata="";break;case"script":P(s,"onscript",s.script),s.script="";break;default:xt(s,"Max buffer length exceeded: "+t[o])}m=Math.max(m,E)}var v=e.MAX_BUFFER_LENGTH-m;s.bufferCheckPosition=v+s.position}function n(s){for(var r=0,m=t.length;r<m;r++)s[t[r]]=""}function l(s){ft(s),s.cdata!==""&&(P(s,"oncdata",s.cdata),s.cdata=""),s.script!==""&&(P(s,"onscript",s.script),s.script="")}a.prototype={end:function(){ue(this)},write:nr,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){l(this)}};var c=ReadableStream;c||(c=function(){});var p=e.EVENTS.filter(function(s){return s!=="error"&&s!=="end"});function f(s,r){return new g(s,r)}function g(s,r){if(!(this instanceof g))return new g(s,r);c.apply(this),this._parser=new a(s,r),this.writable=!0,this.readable=!0;var m=this;this._parser.onend=function(){m.emit("end")},this._parser.onerror=function(o){m.emit("error",o),m._parser.error=null},this._decoder=null,p.forEach(function(o){Object.defineProperty(m,"on"+o,{get:function(){return m._parser["on"+o]},set:function(T){if(!T)return m.removeAllListeners(o),m._parser["on"+o]=T,T;m.on(o,T)},enumerable:!0,configurable:!1})})}g.prototype=Object.create(c.prototype,{constructor:{value:g}}),g.prototype.write=function(s){return this._parser.write(s.toString()),this.emit("data",s),!0},g.prototype.end=function(s){return s&&s.length&&this.write(s),this._parser.end(),!0},g.prototype.on=function(s,r){var m=this;return!m._parser["on"+s]&&p.indexOf(s)!==-1&&(m._parser["on"+s]=function(){var o=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);o.splice(0,0,s),m.emit.apply(m,o)}),c.prototype.on.call(m,s,r)};var x="[CDATA[",M="DOCTYPE",U="http://www.w3.org/XML/1998/namespace",Z="http://www.w3.org/2000/xmlns/",vt={xml:U,xmlns:Z},y=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,V=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,C=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,N=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function w(s){return s===" "||s===`
`||s==="\r"||s==="	"}function $(s){return s==='"'||s==="'"}function z(s){return s===">"||w(s)}function F(s,r){return s.test(r)}function Bt(s,r){return!F(s,r)}var u=0;e.STATE={BEGIN:u++,BEGIN_WHITESPACE:u++,TEXT:u++,TEXT_ENTITY:u++,OPEN_WAKA:u++,SGML_DECL:u++,SGML_DECL_QUOTED:u++,DOCTYPE:u++,DOCTYPE_QUOTED:u++,DOCTYPE_DTD:u++,DOCTYPE_DTD_QUOTED:u++,COMMENT_STARTING:u++,COMMENT:u++,COMMENT_ENDING:u++,COMMENT_ENDED:u++,CDATA:u++,CDATA_ENDING:u++,CDATA_ENDING_2:u++,PROC_INST:u++,PROC_INST_BODY:u++,PROC_INST_ENDING:u++,OPEN_TAG:u++,OPEN_TAG_SLASH:u++,ATTRIB:u++,ATTRIB_NAME:u++,ATTRIB_NAME_SAW_WHITE:u++,ATTRIB_VALUE:u++,ATTRIB_VALUE_QUOTED:u++,ATTRIB_VALUE_CLOSED:u++,ATTRIB_VALUE_UNQUOTED:u++,ATTRIB_VALUE_ENTITY_Q:u++,ATTRIB_VALUE_ENTITY_U:u++,CLOSE_TAG:u++,CLOSE_TAG_SAW_WHITE:u++,SCRIPT:u++,SCRIPT_ENDING:u++},e.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},e.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(e.ENTITIES).forEach(function(s){var r=e.ENTITIES[s],m=typeof r=="number"?String.fromCharCode(r):r;e.ENTITIES[s]=m});for(var oe in e.STATE)e.STATE[e.STATE[oe]]=oe;u=e.STATE;function mt(s,r,m){s[r]&&s[r](m)}function P(s,r,m){s.textNode&&ft(s),mt(s,r,m)}function ft(s){s.textNode=le(s.opt,s.textNode),s.textNode&&mt(s,"ontext",s.textNode),s.textNode=""}function le(s,r){return s.trim&&(r=r.trim()),s.normalize&&(r=r.replace(/\s+/g," ")),r}function xt(s,r){return ft(s),s.trackPosition&&(r+=`
Line: `+s.line+`
Column: `+s.column+`
Char: `+s.c),r=new Error(r),s.error=r,mt(s,"onerror",r),s}function ue(s){return s.sawRoot&&!s.closedRoot&&b(s,"Unclosed root tag"),s.state!==u.BEGIN&&s.state!==u.BEGIN_WHITESPACE&&s.state!==u.TEXT&&xt(s,"Unexpected end"),ft(s),s.c="",s.closed=!0,mt(s,"onend"),a.call(s,s.strict,s.opt),s}function b(s,r){if(typeof s!="object"||!(s instanceof a))throw new Error("bad call to strictFail");s.strict&&xt(s,r)}function sr(s){s.strict||(s.tagName=s.tagName[s.looseCase]());var r=s.tags[s.tags.length-1]||s,m=s.tag={name:s.tagName,attributes:{}};s.opt.xmlns&&(m.ns=r.ns),s.attribList.length=0,P(s,"onopentagstart",m)}function Lt(s,r){var m=s.indexOf(":"),o=m<0?["",s]:s.split(":"),T=o[0],E=o[1];return r&&s==="xmlns"&&(T="xmlns",E=""),{prefix:T,local:E}}function Ut(s){if(s.strict||(s.attribName=s.attribName[s.looseCase]()),s.attribList.indexOf(s.attribName)!==-1||s.tag.attributes.hasOwnProperty(s.attribName)){s.attribName=s.attribValue="";return}if(s.opt.xmlns){var r=Lt(s.attribName,!0),m=r.prefix,o=r.local;if(m==="xmlns")if(o==="xml"&&s.attribValue!==U)b(s,"xml: prefix must be bound to "+U+`
Actual: `+s.attribValue);else if(o==="xmlns"&&s.attribValue!==Z)b(s,"xmlns: prefix must be bound to "+Z+`
Actual: `+s.attribValue);else{var T=s.tag,E=s.tags[s.tags.length-1]||s;T.ns===E.ns&&(T.ns=Object.create(E.ns)),T.ns[o]=s.attribValue}s.attribList.push([s.attribName,s.attribValue])}else s.tag.attributes[s.attribName]=s.attribValue,P(s,"onattribute",{name:s.attribName,value:s.attribValue});s.attribName=s.attribValue=""}function K(s,r){if(s.opt.xmlns){var m=s.tag,o=Lt(s.tagName);m.prefix=o.prefix,m.local=o.local,m.uri=m.ns[o.prefix]||"",m.prefix&&!m.uri&&(b(s,"Unbound namespace prefix: "+JSON.stringify(s.tagName)),m.uri=o.prefix);var T=s.tags[s.tags.length-1]||s;m.ns&&T.ns!==m.ns&&Object.keys(m.ns).forEach(function(he){P(s,"onopennamespace",{prefix:he,uri:m.ns[he]})});for(var E=0,v=s.attribList.length;E<v;E++){var A=s.attribList[E],D=A[0],tt=A[1],S=Lt(D,!0),X=S.prefix,ir=S.local,fe=X===""?"":m.ns[X]||"",kt={name:D,value:tt,prefix:X,local:ir,uri:fe};X&&X!=="xmlns"&&!fe&&(b(s,"Unbound namespace prefix: "+JSON.stringify(X)),kt.uri=X),s.tag.attributes[D]=kt,P(s,"onattribute",kt)}s.attribList.length=0}s.tag.isSelfClosing=!!r,s.sawRoot=!0,s.tags.push(s.tag),P(s,"onopentag",s.tag),r||(!s.noscript&&s.tagName.toLowerCase()==="script"?s.state=u.SCRIPT:s.state=u.TEXT,s.tag=null,s.tagName=""),s.attribName=s.attribValue="",s.attribList.length=0}function jt(s){if(!s.tagName){b(s,"Weird empty close tag."),s.textNode+="</>",s.state=u.TEXT;return}if(s.script){if(s.tagName!=="script"){s.script+="</"+s.tagName+">",s.tagName="",s.state=u.SCRIPT;return}P(s,"onscript",s.script),s.script=""}var r=s.tags.length,m=s.tagName;s.strict||(m=m[s.looseCase]());for(var o=m;r--;){var T=s.tags[r];if(T.name!==o)b(s,"Unexpected close tag");else break}if(r<0){b(s,"Unmatched closing tag: "+s.tagName),s.textNode+="</"+s.tagName+">",s.state=u.TEXT;return}s.tagName=m;for(var E=s.tags.length;E-- >r;){var v=s.tag=s.tags.pop();s.tagName=s.tag.name,P(s,"onclosetag",s.tagName);var A={};for(var D in v.ns)A[D]=v.ns[D];var tt=s.tags[s.tags.length-1]||s;s.opt.xmlns&&v.ns!==tt.ns&&Object.keys(v.ns).forEach(function(S){var X=v.ns[S];P(s,"onclosenamespace",{prefix:S,uri:X})})}r===0&&(s.closedRoot=!0),s.tagName=s.attribValue=s.attribName="",s.attribList.length=0,s.state=u.TEXT}function pe(s){var r=s.entity,m=r.toLowerCase(),o,T="";return s.ENTITIES[r]?s.ENTITIES[r]:s.ENTITIES[m]?s.ENTITIES[m]:(r=m,r.charAt(0)==="#"&&(r.charAt(1)==="x"?(r=r.slice(2),o=parseInt(r,16),T=o.toString(16)):(r=r.slice(1),o=parseInt(r,10),T=o.toString(10))),r=r.replace(/^0+/,""),isNaN(o)||T.toLowerCase()!==r?(b(s,"Invalid character entity"),"&"+s.entity+";"):String.fromCodePoint(o))}function ce(s,r){r==="<"?(s.state=u.OPEN_WAKA,s.startTagPosition=s.position):w(r)||(b(s,"Non-whitespace before first tag."),s.textNode=r,s.state=u.TEXT)}function me(s,r){var m="";return r<s.length&&(m=s.charAt(r)),m}function nr(s){var r=this;if(this.error)throw this.error;if(r.closed)return xt(r,"Cannot write after close. Assign an onready handler.");if(s===null)return ue(r);typeof s=="object"&&(s=s.toString());for(var m=0,o="";o=me(s,m++),r.c=o,!!o;)switch(r.trackPosition&&(r.position++,o===`
`?(r.line++,r.column=0):r.column++),r.state){case u.BEGIN:if(r.state=u.BEGIN_WHITESPACE,o==="\uFEFF")continue;ce(r,o);continue;case u.BEGIN_WHITESPACE:ce(r,o);continue;case u.TEXT:if(r.sawRoot&&!r.closedRoot){for(var T=m-1;o&&o!=="<"&&o!=="&";)o=me(s,m++),o&&r.trackPosition&&(r.position++,o===`
`?(r.line++,r.column=0):r.column++);r.textNode+=s.substring(T,m-1)}o==="<"&&!(r.sawRoot&&r.closedRoot&&!r.strict)?(r.state=u.OPEN_WAKA,r.startTagPosition=r.position):(!w(o)&&(!r.sawRoot||r.closedRoot)&&b(r,"Text data outside of root node."),o==="&"?r.state=u.TEXT_ENTITY:r.textNode+=o);continue;case u.SCRIPT:o==="<"?r.state=u.SCRIPT_ENDING:r.script+=o;continue;case u.SCRIPT_ENDING:o==="/"?r.state=u.CLOSE_TAG:(r.script+="<"+o,r.state=u.SCRIPT);continue;case u.OPEN_WAKA:if(o==="!")r.state=u.SGML_DECL,r.sgmlDecl="";else if(!w(o))if(F(y,o))r.state=u.OPEN_TAG,r.tagName=o;else if(o==="/")r.state=u.CLOSE_TAG,r.tagName="";else if(o==="?")r.state=u.PROC_INST,r.procInstName=r.procInstBody="";else{if(b(r,"Unencoded <"),r.startTagPosition+1<r.position){var E=r.position-r.startTagPosition;o=new Array(E).join(" ")+o}r.textNode+="<"+o,r.state=u.TEXT}continue;case u.SGML_DECL:(r.sgmlDecl+o).toUpperCase()===x?(P(r,"onopencdata"),r.state=u.CDATA,r.sgmlDecl="",r.cdata=""):r.sgmlDecl+o==="--"?(r.state=u.COMMENT,r.comment="",r.sgmlDecl=""):(r.sgmlDecl+o).toUpperCase()===M?(r.state=u.DOCTYPE,(r.doctype||r.sawRoot)&&b(r,"Inappropriately located doctype declaration"),r.doctype="",r.sgmlDecl=""):o===">"?(P(r,"onsgmldeclaration",r.sgmlDecl),r.sgmlDecl="",r.state=u.TEXT):($(o)&&(r.state=u.SGML_DECL_QUOTED),r.sgmlDecl+=o);continue;case u.SGML_DECL_QUOTED:o===r.q&&(r.state=u.SGML_DECL,r.q=""),r.sgmlDecl+=o;continue;case u.DOCTYPE:o===">"?(r.state=u.TEXT,P(r,"ondoctype",r.doctype),r.doctype=!0):(r.doctype+=o,o==="["?r.state=u.DOCTYPE_DTD:$(o)&&(r.state=u.DOCTYPE_QUOTED,r.q=o));continue;case u.DOCTYPE_QUOTED:r.doctype+=o,o===r.q&&(r.q="",r.state=u.DOCTYPE);continue;case u.DOCTYPE_DTD:r.doctype+=o,o==="]"?r.state=u.DOCTYPE:$(o)&&(r.state=u.DOCTYPE_DTD_QUOTED,r.q=o);continue;case u.DOCTYPE_DTD_QUOTED:r.doctype+=o,o===r.q&&(r.state=u.DOCTYPE_DTD,r.q="");continue;case u.COMMENT:o==="-"?r.state=u.COMMENT_ENDING:r.comment+=o;continue;case u.COMMENT_ENDING:o==="-"?(r.state=u.COMMENT_ENDED,r.comment=le(r.opt,r.comment),r.comment&&P(r,"oncomment",r.comment),r.comment=""):(r.comment+="-"+o,r.state=u.COMMENT);continue;case u.COMMENT_ENDED:o!==">"?(b(r,"Malformed comment"),r.comment+="--"+o,r.state=u.COMMENT):r.state=u.TEXT;continue;case u.CDATA:o==="]"?r.state=u.CDATA_ENDING:r.cdata+=o;continue;case u.CDATA_ENDING:o==="]"?r.state=u.CDATA_ENDING_2:(r.cdata+="]"+o,r.state=u.CDATA);continue;case u.CDATA_ENDING_2:o===">"?(r.cdata&&P(r,"oncdata",r.cdata),P(r,"onclosecdata"),r.cdata="",r.state=u.TEXT):o==="]"?r.cdata+="]":(r.cdata+="]]"+o,r.state=u.CDATA);continue;case u.PROC_INST:o==="?"?r.state=u.PROC_INST_ENDING:w(o)?r.state=u.PROC_INST_BODY:r.procInstName+=o;continue;case u.PROC_INST_BODY:if(!r.procInstBody&&w(o))continue;o==="?"?r.state=u.PROC_INST_ENDING:r.procInstBody+=o;continue;case u.PROC_INST_ENDING:o===">"?(P(r,"onprocessinginstruction",{name:r.procInstName,body:r.procInstBody}),r.procInstName=r.procInstBody="",r.state=u.TEXT):(r.procInstBody+="?"+o,r.state=u.PROC_INST_BODY);continue;case u.OPEN_TAG:F(V,o)?r.tagName+=o:(sr(r),o===">"?K(r):o==="/"?r.state=u.OPEN_TAG_SLASH:(w(o)||b(r,"Invalid character in tag name"),r.state=u.ATTRIB));continue;case u.OPEN_TAG_SLASH:o===">"?(K(r,!0),jt(r)):(b(r,"Forward-slash in opening tag not followed by >"),r.state=u.ATTRIB);continue;case u.ATTRIB:if(w(o))continue;o===">"?K(r):o==="/"?r.state=u.OPEN_TAG_SLASH:F(y,o)?(r.attribName=o,r.attribValue="",r.state=u.ATTRIB_NAME):b(r,"Invalid attribute name");continue;case u.ATTRIB_NAME:o==="="?r.state=u.ATTRIB_VALUE:o===">"?(b(r,"Attribute without value"),r.attribValue=r.attribName,Ut(r),K(r)):w(o)?r.state=u.ATTRIB_NAME_SAW_WHITE:F(V,o)?r.attribName+=o:b(r,"Invalid attribute name");continue;case u.ATTRIB_NAME_SAW_WHITE:if(o==="=")r.state=u.ATTRIB_VALUE;else{if(w(o))continue;b(r,"Attribute without value"),r.tag.attributes[r.attribName]="",r.attribValue="",P(r,"onattribute",{name:r.attribName,value:""}),r.attribName="",o===">"?K(r):F(y,o)?(r.attribName=o,r.state=u.ATTRIB_NAME):(b(r,"Invalid attribute name"),r.state=u.ATTRIB)}continue;case u.ATTRIB_VALUE:if(w(o))continue;$(o)?(r.q=o,r.state=u.ATTRIB_VALUE_QUOTED):(b(r,"Unquoted attribute value"),r.state=u.ATTRIB_VALUE_UNQUOTED,r.attribValue=o);continue;case u.ATTRIB_VALUE_QUOTED:if(o!==r.q){o==="&"?r.state=u.ATTRIB_VALUE_ENTITY_Q:r.attribValue+=o;continue}Ut(r),r.q="",r.state=u.ATTRIB_VALUE_CLOSED;continue;case u.ATTRIB_VALUE_CLOSED:w(o)?r.state=u.ATTRIB:o===">"?K(r):o==="/"?r.state=u.OPEN_TAG_SLASH:F(y,o)?(b(r,"No whitespace between attributes"),r.attribName=o,r.attribValue="",r.state=u.ATTRIB_NAME):b(r,"Invalid attribute name");continue;case u.ATTRIB_VALUE_UNQUOTED:if(!z(o)){o==="&"?r.state=u.ATTRIB_VALUE_ENTITY_U:r.attribValue+=o;continue}Ut(r),o===">"?K(r):r.state=u.ATTRIB;continue;case u.CLOSE_TAG:if(r.tagName)o===">"?jt(r):F(V,o)?r.tagName+=o:r.script?(r.script+="</"+r.tagName,r.tagName="",r.state=u.SCRIPT):(w(o)||b(r,"Invalid tagname in closing tag"),r.state=u.CLOSE_TAG_SAW_WHITE);else{if(w(o))continue;Bt(y,o)?r.script?(r.script+="</"+o,r.state=u.SCRIPT):b(r,"Invalid tagname in closing tag."):r.tagName=o}continue;case u.CLOSE_TAG_SAW_WHITE:if(w(o))continue;o===">"?jt(r):b(r,"Invalid characters in closing tag");continue;case u.TEXT_ENTITY:case u.ATTRIB_VALUE_ENTITY_Q:case u.ATTRIB_VALUE_ENTITY_U:var v,A;switch(r.state){case u.TEXT_ENTITY:v=u.TEXT,A="textNode";break;case u.ATTRIB_VALUE_ENTITY_Q:v=u.ATTRIB_VALUE_QUOTED,A="attribValue";break;case u.ATTRIB_VALUE_ENTITY_U:v=u.ATTRIB_VALUE_UNQUOTED,A="attribValue";break}if(o===";")if(r.opt.unparsedEntities){var D=pe(r);r.entity="",r.state=v,r.write(D)}else r[A]+=pe(r),r.entity="",r.state=v;else F(r.entity.length?N:C,o)?r.entity+=o:(b(r,"Invalid character in entity name"),r[A]+="&"+r.entity+o,r.entity="",r.state=v);continue;default:throw new Error(r,"Unknown state: "+r.state)}return r.position>=r.bufferCheckPosition&&i(r),r}return String.fromCodePoint||(function(){var s=String.fromCharCode,r=Math.floor,m=function(){var o=16384,T=[],E,v,A=-1,D=arguments.length;if(!D)return"";for(var tt="";++A<D;){var S=Number(arguments[A]);if(!isFinite(S)||S<0||S>1114111||r(S)!==S)throw RangeError("Invalid code point: "+S);S<=65535?T.push(S):(S-=65536,E=(S>>10)+55296,v=S%1024+56320,T.push(E,v)),(A+1===D||T.length>o)&&(tt+=s.apply(null,T),T.length=0)}return tt};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:m,configurable:!0,writable:!0}):String.fromCodePoint=m})(),e},ke=lr();var Ot=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``,Ge=class extends nt{tags;constructor(e){super(e),this.tags=e?.tags}static lc_name(){return"XMLOutputParser"}lc_namespace=["langchain_core","output_parsers"];lc_serializable=!0;_diff(e,t){if(t)return e?st(e,t):[{op:"replace",path:"",value:t}]}parsePartialResult(e){return h(this,null,function*(){return Nt(e[0].text)})}parse(e){return h(this,null,function*(){return Nt(e)})}getFormatInstructions(){return!!(this.tags&&this.tags.length>0)?Ot.replace("{tags}",this.tags?.join(", ")??""):Ot}},ur=e=>e.split(`
`).map(t=>t.replace(/^\s+/,"")).join(`
`).trim(),$e=e=>{if(Object.keys(e).length===0)return{};let t={};return e.children.length>0?(t[e.name]=e.children.map($e),t):(t[e.name]=e.text??void 0,t)};function Nt(e){let t=ur(e),a=ke.parser(!0),i={},n=[];a.onopentag=p=>{let f={name:p.name,attributes:p.attributes,children:[],text:"",isSelfClosing:p.isSelfClosing};n.length>0?n[n.length-1].children.push(f):i=f,p.isSelfClosing||n.push(f)},a.onclosetag=()=>{if(n.length>0){let p=n.pop();n.length===0&&p&&(i=p)}},a.ontext=p=>{if(n.length>0){let f=n[n.length-1];f.text+=p}},a.onattribute=p=>{if(n.length>0){let f=n[n.length-1];f.attributes[p.name]=p.value}};let l=/```(xml)?(.*)```/s.exec(t),c=l?l[2]:t;return a.write(c).close(),i&&i.name==="?xml"&&(i=i.children[0]),$e(i)}var pr={};rt(pr,{AsymmetricStructuredOutputParser:()=>je,BaseCumulativeTransformOutputParser:()=>nt,BaseLLMOutputParser:()=>Xt,BaseOutputParser:()=>W,BaseTransformOutputParser:()=>Y,BytesOutputParser:()=>Ve,CommaSeparatedListOutputParser:()=>De,CustomListOutputParser:()=>Re,JsonMarkdownStructuredOutputParser:()=>Yt,JsonOutputParser:()=>Fe,ListOutputParser:()=>it,MarkdownListOutputParser:()=>Le,NumberedListOutputParser:()=>Be,OutputParserException:()=>G,StringOutputParser:()=>Ue,StructuredOutputParser:()=>Wt,XMLOutputParser:()=>Ge,XML_FORMAT_INSTRUCTIONS:()=>Ot,parseJsonMarkdown:()=>dt,parsePartialJson:()=>Te,parseXMLMarkdown:()=>Nt});var ze=class extends W{static lc_name(){return"NoOpOutputParser"}lc_namespace=["langchain","output_parsers","default"];lc_serializable=!0;parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}};var B=class extends R{lc_serializable=!0;lc_namespace=["langchain_core","prompts",this._getPromptType()];get lc_attributes(){return{partialVariables:void 0}}inputVariables;outputParser;partialVariables;metadata;tags;constructor(e){super(e);let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}mergePartialAndUserVariables(e){return h(this,null,function*(){let t=this.partialVariables??{},a={};for(let[n,l]of Object.entries(t))typeof l=="string"?a[n]=l:a[n]=yield l();return d(d({},a),e)})}invoke(e,t){return h(this,null,function*(){let a=d(d({},this.metadata),t?.metadata),i=[...this.tags??[],...t?.tags??[]];return this._callWithConfig(n=>this.formatPromptValue(n),e,_(d({},t),{tags:i,metadata:a,runType:"prompt"}))})}};var J=class extends B{formatPromptValue(e){return h(this,null,function*(){let t=yield this.format(e);return new Ie(t)})}};var cr=Object.prototype.toString,lt=Array.isArray||function(t){return cr.call(t)==="[object Array]"};function qt(e){return typeof e=="function"}function mr(e){return lt(e)?"array":typeof e}function Jt(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Xe(e,t){return e!=null&&typeof e=="object"&&t in e}function fr(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}var hr=RegExp.prototype.test;function gr(e,t){return hr.call(e,t)}var dr=/\S/;function Tr(e){return!gr(dr,e)}var br={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function _r(e){return String(e).replace(/[&<>"'`=\/]/g,function(a){return br[a]})}var yr=/\s*/,wr=/\s+/,We=/\s*=/,Pr=/\s*\}/,Er=/#|\^|\/|>|\{|&|=|!/;function vr(e,t){if(!e)return[];var a=!1,i=[],n=[],l=[],c=!1,p=!1,f="",g=0;function x(){if(c&&!p)for(;l.length;)delete n[l.pop()];else l=[];c=!1,p=!1}var M,U,Z;function vt(u){if(typeof u=="string"&&(u=u.split(wr,2)),!lt(u)||u.length!==2)throw new Error("Invalid tags: "+u);M=new RegExp(Jt(u[0])+"\\s*"),U=new RegExp("\\s*"+Jt(u[1])),Z=new RegExp("\\s*"+Jt("}"+u[1]))}vt(t||L.tags);for(var y=new bt(e),V,C,N,w,$,z;!y.eos();){if(V=y.pos,N=y.scanUntil(M),N)for(var F=0,Bt=N.length;F<Bt;++F)w=N.charAt(F),Tr(w)?(l.push(n.length),f+=w):(p=!0,a=!0,f+=" "),n.push(["text",w,V,V+1]),V+=1,w===`
`&&(x(),f="",g=0,a=!1);if(!y.scan(M))break;if(c=!0,C=y.scan(Er)||"name",y.scan(yr),C==="="?(N=y.scanUntil(We),y.scan(We),y.scanUntil(U)):C==="{"?(N=y.scanUntil(Z),y.scan(Pr),y.scanUntil(U),C="&"):N=y.scanUntil(U),!y.scan(U))throw new Error("Unclosed tag at "+y.pos);if(C==">"?$=[C,N,V,y.pos,f,g,a]:$=[C,N,V,y.pos],g++,n.push($),C==="#"||C==="^")i.push($);else if(C==="/"){if(z=i.pop(),!z)throw new Error('Unopened section "'+N+'" at '+V);if(z[1]!==N)throw new Error('Unclosed section "'+z[1]+'" at '+V)}else C==="name"||C==="{"||C==="&"?p=!0:C==="="&&vt(N)}if(x(),z=i.pop(),z)throw new Error('Unclosed section "'+z[1]+'" at '+y.pos);return Sr(xr(n))}function xr(e){for(var t=[],a,i,n=0,l=e.length;n<l;++n)a=e[n],a&&(a[0]==="text"&&i&&i[0]==="text"?(i[1]+=a[1],i[3]=a[3]):(t.push(a),i=a));return t}function Sr(e){for(var t=[],a=t,i=[],n,l,c=0,p=e.length;c<p;++c)switch(n=e[c],n[0]){case"#":case"^":a.push(n),i.push(n),a=n[4]=[];break;case"/":l=i.pop(),l[5]=n[2],a=i.length>0?i[i.length-1][4]:t;break;default:a.push(n)}return t}function bt(e){this.string=e,this.tail=e,this.pos=0}bt.prototype.eos=function(){return this.tail===""};bt.prototype.scan=function(t){var a=this.tail.match(t);if(!a||a.index!==0)return"";var i=a[0];return this.tail=this.tail.substring(i.length),this.pos+=i.length,i};bt.prototype.scanUntil=function(t){var a=this.tail.search(t),i;switch(a){case-1:i=this.tail,this.tail="";break;case 0:i="";break;default:i=this.tail.substring(0,a),this.tail=this.tail.substring(a)}return this.pos+=i.length,i};function ot(e,t){this.view=e,this.cache={".":this.view},this.parent=t}ot.prototype.push=function(t){return new ot(t,this)};ot.prototype.lookup=function(t){var a=this.cache,i;if(a.hasOwnProperty(t))i=a[t];else{for(var n=this,l,c,p,f=!1;n;){if(t.indexOf(".")>0)for(l=n.view,c=t.split("."),p=0;l!=null&&p<c.length;)p===c.length-1&&(f=Xe(l,c[p])||fr(l,c[p])),l=l[c[p++]];else l=n.view[t],f=Xe(n.view,t);if(f){i=l;break}n=n.parent}a[t]=i}return qt(i)&&(i=i.call(this.view)),i};function O(){this.templateCache={_cache:{},set:function(t,a){this._cache[t]=a},get:function(t){return this._cache[t]},clear:function(){this._cache={}}}}O.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};O.prototype.parse=function(t,a){var i=this.templateCache,n=t+":"+(a||L.tags).join(":"),l=typeof i<"u",c=l?i.get(n):void 0;return c==null&&(c=vr(t,a),l&&i.set(n,c)),c};O.prototype.render=function(t,a,i,n){var l=this.getConfigTags(n),c=this.parse(t,l),p=a instanceof ot?a:new ot(a,void 0);return this.renderTokens(c,p,i,t,n)};O.prototype.renderTokens=function(t,a,i,n,l){for(var c="",p,f,g,x=0,M=t.length;x<M;++x)g=void 0,p=t[x],f=p[0],f==="#"?g=this.renderSection(p,a,i,n,l):f==="^"?g=this.renderInverted(p,a,i,n,l):f===">"?g=this.renderPartial(p,a,i,l):f==="&"?g=this.unescapedValue(p,a):f==="name"?g=this.escapedValue(p,a,l):f==="text"&&(g=this.rawValue(p)),g!==void 0&&(c+=g);return c};O.prototype.renderSection=function(t,a,i,n,l){var c=this,p="",f=a.lookup(t[1]);function g(U){return c.render(U,a,i,l)}if(f){if(lt(f))for(var x=0,M=f.length;x<M;++x)p+=this.renderTokens(t[4],a.push(f[x]),i,n,l);else if(typeof f=="object"||typeof f=="string"||typeof f=="number")p+=this.renderTokens(t[4],a.push(f),i,n,l);else if(qt(f)){if(typeof n!="string")throw new Error("Cannot use higher-order sections without the original template");f=f.call(a.view,n.slice(t[3],t[5]),g),f!=null&&(p+=f)}else p+=this.renderTokens(t[4],a,i,n,l);return p}};O.prototype.renderInverted=function(t,a,i,n,l){var c=a.lookup(t[1]);if(!c||lt(c)&&c.length===0)return this.renderTokens(t[4],a,i,n,l)};O.prototype.indentPartial=function(t,a,i){for(var n=a.replace(/[^ \t]/g,""),l=t.split(`
`),c=0;c<l.length;c++)l[c].length&&(c>0||!i)&&(l[c]=n+l[c]);return l.join(`
`)};O.prototype.renderPartial=function(t,a,i,n){if(i){var l=this.getConfigTags(n),c=qt(i)?i(t[1]):i[t[1]];if(c!=null){var p=t[6],f=t[5],g=t[4],x=c;f==0&&g&&(x=this.indentPartial(c,g,p));var M=this.parse(x,l);return this.renderTokens(M,a,i,x,n)}}};O.prototype.unescapedValue=function(t,a){var i=a.lookup(t[1]);if(i!=null)return i};O.prototype.escapedValue=function(t,a,i){var n=this.getConfigEscape(i)||L.escape,l=a.lookup(t[1]);if(l!=null)return typeof l=="number"&&n===L.escape?String(l):n(l)};O.prototype.rawValue=function(t){return t[1]};O.prototype.getConfigTags=function(t){return lt(t)?t:t&&typeof t=="object"?t.tags:void 0};O.prototype.getConfigEscape=function(t){if(t&&typeof t=="object"&&!lt(t))return t.escape};var L={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){Tt.templateCache=e},get templateCache(){return Tt.templateCache}},Tt=new O;L.clearCache=function(){return Tt.clearCache()};L.parse=function(t,a){return Tt.parse(t,a)};L.render=function(t,a,i,n){if(typeof t!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+mr(t)+'" was given as the first argument for mustache#render(template, view, partials)');return Tt.render(t,a,i,n)};L.escape=_r;L.Scanner=bt;L.Context=ot;L.Writer=O;var At=L;function Ye(){At.escape=e=>e}var H=e=>{let t=e.split(""),a=[],i=(l,c)=>{for(let p=c;p<t.length;p+=1)if(l.includes(t[p]))return p;return-1},n=0;for(;n<t.length;)if(t[n]==="{"&&n+1<t.length&&t[n+1]==="{")a.push({type:"literal",text:"{"}),n+=2;else if(t[n]==="}"&&n+1<t.length&&t[n+1]==="}")a.push({type:"literal",text:"}"}),n+=2;else if(t[n]==="{"){let l=i("}",n);if(l<0)throw new Error("Unclosed '{' in template.");a.push({type:"variable",name:t.slice(n+1,l).join("")}),n=l+1}else{if(t[n]==="}")throw new Error("Single '}' in template.");{let l=i("{}",n),c=(l<0?t.slice(n):t.slice(n,l)).join("");a.push({type:"literal",text:c}),n=l<0?t.length:l}}return a},Je=(e,t=[])=>{let a=[];for(let i of e)if(i[0]==="name"){let n=i[1].includes(".")?i[1].split(".")[0]:i[1];a.push({type:"variable",name:n})}else if(["#","&","^",">"].includes(i[0])){if(a.push({type:"variable",name:i[1]}),i[0]==="#"&&i.length>4&&Array.isArray(i[4])){let n=[...t,i[1]],l=Je(i[4],n);a.push(...l)}}else a.push({type:"literal",text:i[1]});return a},ut=e=>{Ye();let t=At.parse(e);return Je(t)},Kt=(e,t)=>H(e).reduce((a,i)=>{if(i.type==="variable"){if(i.name in t){let n=typeof t[i.name]=="string"?t[i.name]:JSON.stringify(t[i.name]);return a+n}throw new Error(`(f-string) Missing value for input ${i.name}`)}return a+i.text},""),Ht=(e,t)=>(Ye(),At.render(e,t)),_t={"f-string":Kt,mustache:Ht},Qt={"f-string":H,mustache:ut},I=(e,t,a)=>{try{return _t[t](e,a)}catch(i){throw at(i,"INVALID_PROMPT_INPUT")}},Q=(e,t)=>Qt[t](e),q=(e,t,a)=>{if(!(t in _t)){let i=Object.keys(_t);throw new Error(`Invalid template format. Got \`${t}\`;
                         should be one of ${i}`)}try{let i=a.reduce((n,l)=>(n[l]="foo",n),{});Array.isArray(e)?e.forEach(n=>{if(n.type==="text"&&"text"in n&&typeof n.text=="string")I(n.text,t,i);else if(n.type==="image_url"){if(typeof n.image_url=="string")I(n.image_url,t,i);else if(typeof n.image_url=="object"&&n.image_url!==null&&"url"in n.image_url&&typeof n.image_url.url=="string"){let l=n.image_url.url;I(l,t,i)}}else throw new Error(`Invalid message template received. ${JSON.stringify(n,null,2)}`)}):I(e,t,i)}catch(i){throw new Error(`Invalid prompt schema: ${i.message}`)}};var k=class yt extends J{static lc_name(){return"PromptTemplate"}template;templateFormat="f-string";validateTemplate=!0;additionalContentFields;constructor(t){if(super(t),t.templateFormat==="mustache"&&t.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,t),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),q(this.template,this.templateFormat,a)}}_getPromptType(){return"prompt"}format(t){return h(this,null,function*(){let a=yield this.mergePartialAndUserVariables(t);return I(this.template,this.templateFormat,a)})}static fromExamples(t,a,i,n=`

`,l=""){let c=[l,...t,a].join(n);return new yt({inputVariables:i,template:c})}static fromTemplate(t,a){let c=a??{},{templateFormat:i="f-string"}=c,n=ge(c,["templateFormat"]),l=new Set;return Q(t,i).forEach(p=>{p.type==="variable"&&l.add(p.name)}),new yt(d({inputVariables:[...l],templateFormat:i,template:t},n))}partial(t){return h(this,null,function*(){let a=this.inputVariables.filter(l=>!(l in t)),i=d(d({},this.partialVariables??{}),t),n=_(d({},this),{inputVariables:a,partialVariables:i});return new yt(n)})}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static deserialize(t){return h(this,null,function*(){if(!t.template)throw new Error("Prompt template must have a template");return new yt({inputVariables:t.input_variables,template:t.template,templateFormat:t.template_format})})}};var pt=class qe extends B{static lc_name(){return"ImagePromptTemplate"}lc_namespace=["langchain_core","prompts","image"];template;templateFormat="f-string";validateTemplate=!0;additionalContentFields;constructor(t){if(super(t),this.template=t.template,this.templateFormat=t.templateFormat??this.templateFormat,this.validateTemplate=t.validateTemplate??this.validateTemplate,this.additionalContentFields=t.additionalContentFields,this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),q([{type:"image_url",image_url:this.template}],this.templateFormat,a)}}_getPromptType(){return"prompt"}partial(t){return h(this,null,function*(){let a=this.inputVariables.filter(l=>!(l in t)),i=d(d({},this.partialVariables??{}),t),n=_(d({},this),{inputVariables:a,partialVariables:i});return new qe(n)})}format(t){return h(this,null,function*(){let a={};for(let[c,p]of Object.entries(this.template))typeof p=="string"?a[c]=I(p,this.templateFormat,t):a[c]=p;let i=t.url||a.url,n=t.detail||a.detail;if(!i)throw new Error("Must provide either an image URL.");if(typeof i!="string")throw new Error("url must be a string.");let l={url:i};return n&&(l.detail=n),l})}formatPromptValue(t){return h(this,null,function*(){let a=yield this.format(t);return new Ne(a)})}};var wt=class extends R{lc_namespace=["langchain_core","prompts","dict"];lc_serializable=!0;template;templateFormat;inputVariables;static lc_name(){return"DictPromptTemplate"}constructor(e){let t=e.templateFormat??"f-string",a=Zt(e.template,t);super(d({inputVariables:a},e)),this.template=e.template,this.templateFormat=t,this.inputVariables=a}format(e){return h(this,null,function*(){return te(this.template,e,this.templateFormat)})}invoke(e){return h(this,null,function*(){return yield this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})})}};function Zt(e,t){let a=[];for(let i of Object.values(e))if(typeof i=="string")Q(i,t).forEach(n=>{n.type==="variable"&&a.push(n.name)});else if(Array.isArray(i))for(let n of i)typeof n=="string"?Q(n,t).forEach(l=>{l.type==="variable"&&a.push(l.name)}):typeof n=="object"&&a.push(...Zt(n,t));else typeof i=="object"&&i!==null&&a.push(...Zt(i,t));return Array.from(new Set(a))}function te(e,t,a){let i={};for(let[n,l]of Object.entries(e))if(typeof l=="string")i[n]=I(l,a,t);else if(Array.isArray(l)){let c=[];for(let p of l)typeof p=="string"?c.push(I(p,a,t)):typeof p=="object"&&c.push(te(p,t,a));i[n]=c}else typeof l=="object"&&l!==null?i[n]=te(l,t,a):i[n]=l;return i}var Pt=class extends R{lc_namespace=["langchain_core","prompts","chat"];lc_serializable=!0;invoke(e,t){return h(this,null,function*(){return this._callWithConfig(a=>this.formatMessages(a),e,_(d({},t),{runType:"prompt"}))})}},Ft=class extends Pt{static lc_name(){return"MessagesPlaceholder"}variableName;optional;constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}formatMessages(e){return h(this,null,function*(){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let i=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw i.name="InputFormatError",i}let a;try{Array.isArray(t)?a=t.map(It):a=[It(t)]}catch(i){let n=typeof t=="string"?t:JSON.stringify(t,null,2),l=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${n}`,`Additional message: ${i.message}`].join(`

`));throw l.name="InputFormatError",l.lc_error_code=i.lc_error_code,l}return a})}},ee=class extends Pt{prompt;constructor(e){"prompt"in e||(e={prompt:e}),super(e),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}formatMessages(e){return h(this,null,function*(){return[yield this.format(e)]})}},Et=class extends B{constructor(e){super(e)}format(e){return h(this,null,function*(){return(yield this.formatPromptValue(e)).toString()})}formatPromptValue(e){return h(this,null,function*(){let t=yield this.formatMessages(e);return new Oe(t)})}},re=class extends ee{static lc_name(){return"ChatMessagePromptTemplate"}role;constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),this.role=e.role}format(e){return h(this,null,function*(){return new Gt(yield this.prompt.format(e),this.role)})}static fromTemplate(e,t,a){return new this(k.fromTemplate(e,{templateFormat:a?.templateFormat}),t)}};function Cr(e){return e===null||typeof e!="object"||Array.isArray(e)?!1:Object.keys(e).length===1&&"text"in e&&typeof e.text=="string"}function Ir(e){return e===null||typeof e!="object"||Array.isArray(e)?!1:"image_url"in e&&(typeof e.image_url=="string"||typeof e.image_url=="object"&&e.image_url!==null&&"url"in e.image_url&&typeof e.image_url.url=="string")}var ae=class extends Pt{lc_namespace=["langchain_core","prompts","chat"];lc_serializable=!0;inputVariables=[];additionalOptions={};prompt;messageClass;static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}chatMessageClass;constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),this.prompt=e.prompt,Array.isArray(this.prompt)){let a=[];this.prompt.forEach(i=>{"inputVariables"in i&&(a=a.concat(i.inputVariables))}),this.inputVariables=a}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let a=t._messageClass();return new a({content:e})}else if(t.chatMessageClass){let a=t.chatMessageClass();return new a({content:e,role:this.getRoleFromMessageClass(a.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(k.fromTemplate(e,t));let a=[];for(let i of e)if(typeof i=="string")a.push(k.fromTemplate(i,t));else if(i!==null)if(Cr(i)){let n="";typeof i.text=="string"&&(n=i.text??"");let l=_(d({},t),{additionalContentFields:i});a.push(k.fromTemplate(n,l))}else if(Ir(i)){let n=i.image_url??"",l,c=[];if(typeof n=="string"){let p;t?.templateFormat==="mustache"?p=ut(n):p=H(n);let f=p.flatMap(g=>g.type==="variable"?[g.name]:[]);if((f?.length??0)>0){if(f.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${f}
From: ${n}`);c=[f[0]]}else c=[];n={url:n},l=new pt({template:n,inputVariables:c,templateFormat:t?.templateFormat,additionalContentFields:i})}else if(typeof n=="object"){if("url"in n){let p;t?.templateFormat==="mustache"?p=ut(n.url):p=H(n.url),c=p.flatMap(f=>f.type==="variable"?[f.name]:[])}else c=[];l=new pt({template:n,inputVariables:c,templateFormat:t?.templateFormat,additionalContentFields:i})}else throw new Error("Invalid image template");a.push(l)}else typeof i=="object"&&a.push(new wt({template:i,templateFormat:t?.templateFormat}));return new this({prompt:a,additionalOptions:t})}format(e){return h(this,null,function*(){if(this.prompt instanceof J){let t=yield this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let a of this.prompt){let i={};if(!("inputVariables"in a))throw new Error(`Prompt ${a} does not have inputVariables defined.`);for(let n of a.inputVariables)i||(i={[n]:e[n]}),i=_(d({},i),{[n]:e[n]});if(a instanceof J){let n=yield a.format(i),l;"additionalContentFields"in a&&(l=a.additionalContentFields),n!==""&&t.push(_(d({},l),{type:"text",text:n}))}else if(a instanceof pt){let n=yield a.format(i),l;"additionalContentFields"in a&&(l=a.additionalContentFields),t.push(_(d({},l),{type:"image_url",image_url:n}))}else if(a instanceof wt){let n=yield a.format(i),l;"additionalContentFields"in a&&(l=a.additionalContentFields),t.push(d(d({},l),n))}}return this.createMessage(t)}})}formatMessages(e){return h(this,null,function*(){return[yield this.format(e)]})}},Vt=class extends ae{static _messageClass(){return _e}static lc_name(){return"HumanMessagePromptTemplate"}},se=class extends ae{static _messageClass(){return we}static lc_name(){return"AIMessagePromptTemplate"}},ne=class extends ae{static _messageClass(){return ye}static lc_name(){return"SystemMessagePromptTemplate"}};function Or(e){return typeof e.formatMessages=="function"}function Nr(e,t){if(Or(e)||Ct(e))return e;if(Array.isArray(e)&&e[0]==="placeholder"){let n=e[1];if(t?.templateFormat==="mustache"&&typeof n=="string"&&n.slice(0,2)==="{{"&&n.slice(-2)==="}}"){let l=n.slice(2,-2);return new Ft({variableName:l,optional:!0})}else if(typeof n=="string"&&n[0]==="{"&&n[n.length-1]==="}"){let l=n.slice(1,-1);return new Ft({variableName:l,optional:!0})}throw new Error(`Invalid placeholder template for format ${t?.templateFormat??'"f-string"'}: "${e[1]}". Expected a variable name surrounded by ${t?.templateFormat==="mustache"?"double":"single"} curly braces.`)}let a=It(e),i;if(typeof a.content=="string"?i=a.content:i=a.content.map(n=>"text"in n?_(d({},n),{text:n.text}):"image_url"in n?_(d({},n),{image_url:n.image_url}):n),a._getType()==="human")return Vt.fromTemplate(i,t);if(a._getType()==="ai")return se.fromTemplate(i,t);if(a._getType()==="system")return ne.fromTemplate(i,t);if(Gt.isInstance(a))return re.fromTemplate(a.content,a.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${a._getType()}".`)}function Ar(e){return e.constructor.lc_name()==="MessagesPlaceholder"}var ct=class Mt extends Et{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}promptMessages;validateTemplate=!0;templateFormat="f-string";constructor(t){if(super(t),t.templateFormat==="mustache"&&t.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,t),this.validateTemplate){let a=new Set;for(let p of this.promptMessages)if(!(p instanceof St))for(let f of p.inputVariables)a.add(f);let i=this.inputVariables,n=new Set(this.partialVariables?i.concat(Object.keys(this.partialVariables)):i),l=new Set([...n].filter(p=>!a.has(p)));if(l.size>0)throw new Error(`Input variables \`${[...l]}\` are not used in any of the prompt messages.`);let c=new Set([...a].filter(p=>!n.has(p)));if(c.size>0)throw new Error(`Input variables \`${[...c]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}_parseImagePrompts(t,a){return h(this,null,function*(){if(typeof t.content=="string")return t;let i=yield Promise.all(t.content.map(n=>h(this,null,function*(){if(n.type!=="image_url")return n;let l="";typeof n.image_url=="string"?l=n.image_url:typeof n.image_url=="object"&&n.image_url!==null&&"url"in n.image_url&&typeof n.image_url.url=="string"&&(l=n.image_url.url);let p=yield k.fromTemplate(l,{templateFormat:this.templateFormat}).format(a);return typeof n.image_url=="object"&&n.image_url!==null&&"url"in n.image_url?n.image_url.url=p:n.image_url=p,n})));return t.content=i,t})}formatMessages(t){return h(this,null,function*(){let a=yield this.mergePartialAndUserVariables(t),i=[];for(let n of this.promptMessages)if(n instanceof St)i.push(yield this._parseImagePrompts(n,a));else{let l;this.templateFormat==="mustache"?l=d({},a):l=n.inputVariables.reduce((p,f)=>{if(!(f in a)&&!(Ar(n)&&n.optional))throw at(new Error(`Missing value for input variable \`${f.toString()}\``),"INVALID_PROMPT_INPUT");return p[f]=a[f],p},{});let c=yield n.formatMessages(l);i=i.concat(c)}return i})}partial(t){return h(this,null,function*(){let a=this.inputVariables.filter(l=>!(l in t)),i=d(d({},this.partialVariables??{}),t),n=_(d({},this),{inputVariables:a,partialVariables:i});return new Mt(n)})}static fromTemplate(t,a){let i=k.fromTemplate(t,a),n=new Vt({prompt:i});return this.fromMessages([n])}static fromMessages(t,a){let i=t.reduce((c,p)=>c.concat(p instanceof Mt?p.promptMessages:[Nr(p,a)]),[]),n=t.reduce((c,p)=>p instanceof Mt?Object.assign(c,p.partialVariables):c,Object.create(null)),l=new Set;for(let c of i)if(!(c instanceof St))for(let p of c.inputVariables)p in n||l.add(p);return new this(_(d({},a),{inputVariables:[...l],promptMessages:i,partialVariables:n,templateFormat:a?.templateFormat}))}};var Ke=class ie extends J{lc_serializable=!1;examples;exampleSelector;examplePrompt;suffix="";exampleSeparator=`

`;prefix="";templateFormat="f-string";validateTemplate=!0;constructor(t){if(super(t),Object.assign(this,t),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),q(this.prefix+this.suffix,this.templateFormat,a)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}getExamples(t){return h(this,null,function*(){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(t);throw new Error("One of 'examples' and 'example_selector' should be provided")})}partial(t){return h(this,null,function*(){let a=this.inputVariables.filter(l=>!(l in t)),i=d(d({},this.partialVariables??{}),t),n=_(d({},this),{inputVariables:a,partialVariables:i});return new ie(n)})}format(t){return h(this,null,function*(){let a=yield this.mergePartialAndUserVariables(t),i=yield this.getExamples(a),n=yield Promise.all(i.map(c=>this.examplePrompt.format(c))),l=[this.prefix,...n,this.suffix].join(this.exampleSeparator);return I(l,this.templateFormat,a)})}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static deserialize(t){return h(this,null,function*(){let{example_prompt:a}=t;if(!a)throw new Error("Missing example prompt");let i=yield k.deserialize(a),n;if(Array.isArray(t.examples))n=t.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new ie({inputVariables:t.input_variables,examplePrompt:i,examples:n,exampleSeparator:t.example_separator,prefix:t.prefix,suffix:t.suffix,templateFormat:t.template_format})})}},He=class Qe extends Et{lc_serializable=!0;examples;exampleSelector;examplePrompt;suffix="";exampleSeparator=`

`;prefix="";templateFormat="f-string";validateTemplate=!0;_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(t){if(super(t),this.examples=t.examples,this.examplePrompt=t.examplePrompt,this.exampleSeparator=t.exampleSeparator??`

`,this.exampleSelector=t.exampleSelector,this.prefix=t.prefix??"",this.suffix=t.suffix??"",this.templateFormat=t.templateFormat??"f-string",this.validateTemplate=t.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),q(this.prefix+this.suffix,this.templateFormat,a)}}getExamples(t){return h(this,null,function*(){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(t);throw new Error("One of 'examples' and 'example_selector' should be provided")})}formatMessages(t){return h(this,null,function*(){let a=yield this.mergePartialAndUserVariables(t),i=yield this.getExamples(a);i=i.map(l=>{let c={};return this.examplePrompt.inputVariables.forEach(p=>{c[p]=l[p]}),c});let n=[];for(let l of i){let c=yield this.examplePrompt.formatMessages(l);n.push(...c)}return n})}format(t){return h(this,null,function*(){let a=yield this.mergePartialAndUserVariables(t),i=yield this.getExamples(a),l=(yield Promise.all(i.map(p=>this.examplePrompt.formatMessages(p)))).flat().map(p=>p.content),c=[this.prefix,...l,this.suffix].join(this.exampleSeparator);return I(c,this.templateFormat,a)})}partial(t){return h(this,null,function*(){let a=this.inputVariables.filter(l=>!(l in t)),i=d(d({},this.partialVariables??{}),t),n=_(d({},this),{inputVariables:a,partialVariables:i});return new Qe(n)})}};var Ze=class Dt extends B{static lc_name(){return"PipelinePromptTemplate"}pipelinePrompts;finalPrompt;constructor(t){super(_(d({},t),{inputVariables:[]})),this.pipelinePrompts=t.pipelinePrompts,this.finalPrompt=t.finalPrompt,this.inputVariables=this.computeInputValues()}computeInputValues(){let t=this.pipelinePrompts.map(i=>i.name),a=this.pipelinePrompts.map(i=>i.prompt.inputVariables.filter(n=>!t.includes(n))).flat();return[...new Set(a)]}static extractRequiredInputValues(t,a){return a.reduce((i,n)=>(i[n]=t[n],i),{})}formatPipelinePrompts(t){return h(this,null,function*(){let a=yield this.mergePartialAndUserVariables(t);for(let{name:i,prompt:n}of this.pipelinePrompts){let l=Dt.extractRequiredInputValues(a,n.inputVariables);n instanceof ct?a[i]=yield n.formatMessages(l):a[i]=yield n.format(l)}return Dt.extractRequiredInputValues(a,this.finalPrompt.inputVariables)})}formatPromptValue(t){return h(this,null,function*(){return this.finalPrompt.formatPromptValue(yield this.formatPipelinePrompts(t))})}format(t){return h(this,null,function*(){return this.finalPrompt.format(yield this.formatPipelinePrompts(t))})}partial(t){return h(this,null,function*(){let a=d({},this);return a.inputVariables=this.inputVariables.filter(i=>!(i in t)),a.partialVariables=d(d({},this.partialVariables??{}),t),new Dt(a)})}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function tr(e){return typeof e=="object"&&e!=null&&"withStructuredOutput"in e&&typeof e.withStructuredOutput=="function"}function Mr(e){return typeof e=="object"&&e!=null&&"lc_id"in e&&Array.isArray(e.lc_id)&&e.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var er=class rr extends ct{schema;method;lc_namespace=["langchain_core","prompts","structured"];get lc_aliases(){return _(d({},super.lc_aliases),{schema:"schema_"})}constructor(t){super(t),this.schema=t.schema,this.method=t.method}pipe(t){if(tr(t))return super.pipe(t.withStructuredOutput(this.schema));if(Mr(t)&&tr(t.bound))return super.pipe(new Ce({bound:t.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:t.kwargs??{},config:t.config,configFactories:t.configFactories}));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(t,a,i){return rr.fromMessages(t,{schema:a,method:i})}};var Fr={};rt(Fr,{AIMessagePromptTemplate:()=>se,BaseChatPromptTemplate:()=>Et,BaseMessagePromptTemplate:()=>Pt,BaseMessageStringPromptTemplate:()=>ee,BasePromptTemplate:()=>B,BaseStringPromptTemplate:()=>J,ChatMessagePromptTemplate:()=>re,ChatPromptTemplate:()=>ct,DEFAULT_FORMATTER_MAPPING:()=>_t,DEFAULT_PARSER_MAPPING:()=>Qt,DictPromptTemplate:()=>wt,FewShotChatMessagePromptTemplate:()=>He,FewShotPromptTemplate:()=>Ke,HumanMessagePromptTemplate:()=>Vt,ImagePromptTemplate:()=>pt,MessagesPlaceholder:()=>Ft,PipelinePromptTemplate:()=>Ze,PromptTemplate:()=>k,StructuredPrompt:()=>er,SystemMessagePromptTemplate:()=>ne,checkValidTemplate:()=>q,interpolateFString:()=>Kt,interpolateMustache:()=>Ht,parseFString:()=>H,parseMustache:()=>ut,parseTemplate:()=>Q,renderTemplate:()=>I});function Vr(e){return typeof e._llmType=="function"}function Rt(e){if(Vr(e))return e;if("bound"in e&&R.isRunnable(e.bound))return Rt(e.bound);if("runnable"in e&&"fallbacks"in e&&R.isRunnable(e.runnable))return Rt(e.runnable);if("default"in e&&R.isRunnable(e.default))return Rt(e.default);throw new Error("Unable to extract BaseLanguageModel from llmLike object.")}var Dn=class ar extends Me{static lc_name(){return"LLMChain"}lc_serializable=!0;prompt;llm;llmKwargs;outputKey="text";outputParser;get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(t){if(super(t),this.prompt=t.prompt,this.llm=t.llm,this.llmKwargs=t.llmKwargs,this.outputKey=t.outputKey??this.outputKey,this.outputParser=t.outputParser??new ze,this.prompt.outputParser){if(t.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}getCallKeys(){return"callKeys"in this.llm?this.llm.callKeys:[]}_selectMemoryInputs(t){let a=super._selectMemoryInputs(t),i=this.getCallKeys();for(let n of i)n in t&&delete a[n];return a}_getFinalOutput(t,a,i){return h(this,null,function*(){let n;return this.outputParser?n=yield this.outputParser.parseResultWithPrompt(t,a,i?.getChild()):n=t[0].text,n})}call(t,a){return super.call(t,a)}_call(t,a){return h(this,null,function*(){let i=d({},t),n=d({},this.llmKwargs),l=this.getCallKeys();for(let g of l)g in t&&n&&(n[g]=t[g],delete i[g]);let c=yield this.prompt.formatPromptValue(i);if("generatePrompt"in this.llm){let{generations:g}=yield this.llm.generatePrompt([c],n,a?.getChild());return{[this.outputKey]:yield this._getFinalOutput(g[0],c,a)}}let f=yield(this.outputParser?this.llm.pipe(this.outputParser):this.llm).invoke(c,a?.getChild());return{[this.outputKey]:f}})}predict(t,a){return h(this,null,function*(){return(yield this.call(t,a))[this.outputKey]})}_chainType(){return"llm"}static deserialize(t){return h(this,null,function*(){let{llm:a,prompt:i}=t;if(!a)throw new Error("LLMChain must have llm");if(!i)throw new Error("LLMChain must have prompt");return new ar({llm:yield Ae.deserialize(a),prompt:yield B.deserialize(i)})})}serialize(){let t="serialize"in this.llm?this.llm.serialize():void 0;return{_type:`${this._chainType()}_chain`,llm:t,prompt:this.prompt.serialize()}}_getNumTokens(t){return Rt(this.llm).getNumTokens(t)}};export{Xt as a,W as b,G as c,nt as d,or as e,Fe as f,Ue as g,Wt as h,pr as i,k as j,Ft as k,Vt as l,se as m,ne as n,ct as o,Fr as p,Dn as q};
